import React, { useState, useEffect, useRef } from 'react';
import { Mic, Speaker, Activity, ChevronDown, ShieldAlert, Monitor, HelpCircle, MicOff } from 'lucide-react';

// --- UI Components ---
const Select = ({ label, options, defaultValue }) => (
  <div className="flex flex-col gap-2 w-full">
    <label className="text-xs font-bold text-gray-400 uppercase tracking-wide">{label}</label>
    <div className="relative">
      <select 
        className="w-full bg-[#121212] text-white p-3 rounded text-sm border border-gray-800 focus:border-purple-500 outline-none appearance-none cursor-pointer transition-colors hover:bg-[#1a1a1a]"
        defaultValue={defaultValue}
      >
        {options.map((opt, i) => (
          <option key={i} value={opt}>{opt}</option>
        ))}
      </select>
      <ChevronDown className="absolute right-3 top-3 text-gray-400 w-4 h-4 pointer-events-none" />
    </div>
  </div>
);

const VolumeSlider = ({ label, value, onChange }) => (
  <div className="flex flex-col gap-2 w-full">
    <label className="text-xs font-bold text-gray-400 uppercase tracking-wide">{label}</label>
    <input
      type="range"
      min="0"
      max="100"
      value={value}
      onChange={(e) => onChange(e.target.value)}
      className="w-full h-2 bg-[#333] rounded-lg appearance-none cursor-pointer accent-purple-600 hover:accent-purple-500"
    />
  </div>
);

const RadioOption = ({ selected, onClick, label, description }) => (
  <div 
    onClick={onClick}
    className="flex items-center gap-3 cursor-pointer group"
  >
    <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center transition-colors ${selected ? 'border-purple-500' : 'border-gray-600 group-hover:border-gray-400'}`}>
      {selected && <div className="w-2.5 h-2.5 bg-purple-500 rounded-full shadow-[0_0_8px_rgba(168,85,247,0.6)]" />}
    </div>
    <div>
      <div className={`text-sm font-medium ${selected ? 'text-white' : 'text-gray-300'}`}>{label}</div>
      {description && <div className="text-xs text-gray-500 mt-0.5">{description}</div>}
    </div>
  </div>
);

// --- MAIN APP COMPONENT ---
export default function App() {
  // State
  const [inputVol, setInputVol] = useState(100);
  const [outputVol, setOutputVol] = useState(70);
  const [sensitivity, setSensitivity] = useState(-50); // Threshold in dB (-100 to 0)
  const [isAutomatic, setIsAutomatic] = useState(false);
  const [inputMode, setInputMode] = useState('activity'); // 'activity' or 'ptt'
  
  // Audio Logic State
  const [isTesting, setIsTesting] = useState(false); // "Kontrol Edelim" button state
  const [currentDb, setCurrentDb] = useState(-100); // Live volume level
  const [micError, setMicError] = useState(null);
  
  const audioContextRef = useRef(null);
  const analyserRef = useRef(null);
  const sourceRef = useRef(null);
  const rafRef = useRef(null);
  const streamRef = useRef(null);

  // Helper: Convert raw amplitude to dB
  const getDbFromAnalyser = (analyser) => {
    const dataArray = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(dataArray);
    
    let sum = 0;
    for(let i = 0; i < dataArray.length; i++) {
        sum += dataArray[i];
    }
    const average = sum / dataArray.length;
    
    if (average === 0) return -100;
    const normalized = (average / 255) * 100 - 100; 
    return Math.max(-100, Math.min(0, normalized));
  };

  // Start/Stop Audio Processing
  const toggleMicTest = async () => {
    if (isTesting) {
      stopAudio();
    } else {
      startAudio();
    }
  };

  const startAudio = async () => {
    try {
      setMicError(null);
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      streamRef.current = stream;

      const AudioContext = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioContext();
      audioContextRef.current = ctx;

      const analyser = ctx.createAnalyser();
      analyser.fftSize = 256;
      analyserRef.current = analyser;

      const source = ctx.createMediaStreamSource(stream);
      sourceRef.current = source;
      
      source.connect(analyser);
      analyser.connect(ctx.destination);

      setIsTesting(true);
      animate();
    } catch (err) {
      console.error("Mic Error:", err);
      setMicError("Mikrofon erişimi reddedildi veya bulunamadı.");
      setIsTesting(true);
      simulateAudio();
    }
  };

  const stopAudio = () => {
    setIsTesting(false);
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => track.stop());
    }
    if (audioContextRef.current) {
      audioContextRef.current.close();
    }
    if (rafRef.current) {
      cancelAnimationFrame(rafRef.current);
    }
    setCurrentDb(-100);
  };

  const animate = () => {
    if (analyserRef.current) {
      const db = getDbFromAnalyser(analyserRef.current);
      setCurrentDb(prev => prev * 0.8 + db * 0.2);
      rafRef.current = requestAnimationFrame(animate);
    }
  };

  const simulateAudio = () => {
    const sim = () => {
       const noise = -80 + Math.random() * 10;
       const voice = Math.random() > 0.7 ? Math.random() * 60 : 0;
       setCurrentDb(Math.min(0, Math.max(-100, noise + voice)));
       rafRef.current = requestAnimationFrame(sim);
    };
    sim();
  };

  useEffect(() => {
    return () => stopAudio();
  }, []);

  const dbToPercent = (db) => Math.max(0, Math.min(100, db + 100));

  return (
    <div className="min-h-screen bg-black text-white font-sans p-4 md:p-8 flex justify-center overflow-y-auto">
      <div className="w-full max-w-3xl space-y-8 pb-20">
        
        {/* Header Tabs */}
        <div className="border-b border-gray-800 pb-1">
          <div className="flex gap-6 text-sm">
            <span className="pb-3 border-b-2 border-purple-500 font-medium text-white cursor-pointer">Ses</span>
            <span className="pb-3 text-gray-500 hover:text-gray-300 cursor-pointer transition-colors">Video</span>
            <span className="pb-3 text-gray-500 hover:text-gray-300 cursor-pointer transition-colors">Ses Paneli</span>
            <span className="pb-3 text-gray-500 hover:text-gray-300 cursor-pointer transition-colors">Hata ayıklama</span>
          </div>
        </div>

        {/* Devices */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <Select 
            label="Giriş Aygıtı" 
            options={['Varsayılan - Mikrofon (Realtek Audio)', 'Headset Mic (Wireless)']} 
            defaultValue="Varsayılan - Mikrofon (Realtek Audio)"
          />
          <Select 
            label="Çıkış Aygıtı" 
            options={['Varsayılan - Speakers (Realtek Audio)', 'Headphones (Wireless)']} 
            defaultValue="Varsayılan - Speakers (Realtek Audio)"
          />
        </div>

        {/* Sliders */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <VolumeSlider label="Giriş Sesi" value={inputVol} onChange={setInputVol} />
          <VolumeSlider label="Çıkış Sesi" value={outputVol} onChange={setOutputVol} />
        </div>

        {/* Mic Test Section */}
        <div className="space-y-2">
          <label className="text-xs font-bold text-gray-400 uppercase tracking-wide">Mikrofon Testi</label>
          <p className="text-sm text-gray-400 mb-2">
            Mikrofonunda sorun mu var? Bir test yap ve komik bir şey söyle, sonra sesini sana dinleteceğiz.
          </p>
          
          {micError && (
             <div className="bg-red-900/20 text-red-400 text-xs p-2 rounded border border-red-500/30 mb-2 flex items-center gap-2">
                <MicOff className="w-4 h-4" /> {micError}
             </div>
          )}

          <div className="bg-[#121212] border border-gray-800 p-2 rounded-lg flex items-center gap-3">
            <button 
              onClick={toggleMicTest}
              className={`px-6 py-2 rounded text-sm font-medium transition-all shadow-lg whitespace-nowrap w-36 ${
                isTesting 
                  ? 'bg-red-600 hover:bg-red-700 text-white shadow-red-900/20' 
                  : 'bg-purple-600 hover:bg-purple-700 text-white shadow-purple-900/30'
              }`}
            >
              {isTesting ? 'Durdur' : 'Kontrol Edelim'}
            </button>
            
            {/* Volume Meter for Test */}
            <div className="flex-1 h-8 flex items-center gap-[2px] overflow-hidden opacity-90 bg-black px-1 rounded border border-gray-800">
               {Array.from({ length: 50 }).map((_, i) => {
                 const percent = dbToPercent(currentDb);
                 const isActive = isTesting && (i * 2) < percent;
                 
                 // Functionality colors (Green/Yellow/Red) kept for logic clarity
                 let barColor = 'bg-green-500';
                 if (i > 35) barColor = 'bg-yellow-400';
                 if (i > 45) barColor = 'bg-red-500';
                 
                 return (
                   <div 
                     key={i} 
                     className={`flex-1 rounded-full transition-all duration-75 ${
                       isActive ? `${barColor} h-5 opacity-100 shadow-[0_0_5px_rgba(255,255,255,0.3)]` : 'bg-gray-800 h-1 opacity-30'
                     }`} 
                   />
                 );
               })}
            </div>
          </div>
        </div>

        <hr className="border-gray-800" />

        {/* Input Mode */}
        <div className="space-y-4">
          <label className="text-xs font-bold text-gray-400 uppercase tracking-wide">Giriş Modu</label>
          <div className="space-y-3">
            <div className="bg-[#121212] border border-gray-800 p-3 rounded flex items-center hover:border-gray-700 transition-colors">
               <RadioOption 
                 selected={inputMode === 'activity'} 
                 onClick={() => setInputMode('activity')} 
                 label="Ses Etkinliği" 
               />
            </div>
            <RadioOption 
                 selected={inputMode === 'ptt'} 
                 onClick={() => setInputMode('ptt')} 
                 label="Bas-Konuş" 
               />
          </div>
        </div>

        {/* SENSITIVITY SETTINGS */}
        {inputMode === 'activity' && (
          <div className="space-y-2 animate-in fade-in slide-in-from-top-2 duration-300">
             <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <input 
                    type="checkbox" 
                    id="auto-sens"
                    checked={isAutomatic}
                    onChange={(e) => setIsAutomatic(e.target.checked)}
                    className="w-4 h-4 rounded bg-[#121212] border-gray-600 accent-purple-600"
                  />
                  <label htmlFor="auto-sens" className="text-sm text-gray-300 cursor-pointer select-none hover:text-white">Giriş Duyarlılığını Otomatik Belirle</label>
                </div>
             </div>

             <div className={`transition-opacity duration-200 ${isAutomatic ? 'opacity-50 pointer-events-none' : 'opacity-100'}`}>
                <div className="flex justify-between items-center mb-1">
                  <label className="text-xs font-bold text-gray-400 uppercase">Giriş Duyarlılığı</label>
                  <span className="text-xs bg-[#121212] border border-gray-800 px-2 py-1 rounded text-purple-300 font-mono">
                    {sensitivity}dB
                  </span>
                </div>

                {/* MAIN SENSITIVITY BAR */}
                <div className="relative w-full h-12 bg-[#121212] rounded-lg border border-gray-800 select-none group shadow-inner">
                    
                    {/* 1. Background Bar */}
                    <div className="absolute inset-x-2 top-1/2 -translate-y-1/2 h-3 rounded-full bg-[#000] overflow-hidden flex border border-gray-900">
                        {/* Silence Zone (Yellow tint to indicate noise/block) */}
                        <div 
                          className="h-full bg-[#3a3d46] opacity-50" 
                          style={{ width: `${dbToPercent(sensitivity)}%` }} 
                        />
                        {/* Transmit Zone (Green tint to indicate open mic) */}
                        <div 
                          className="h-full bg-[#2d3832] opacity-50" 
                          style={{ width: `${100 - dbToPercent(sensitivity)}%` }} 
                        />
                    </div>

                    {/* 2. VISUALIZER */}
                    <div className="absolute inset-x-2 top-1/2 -translate-y-1/2 h-3 rounded-full overflow-hidden pointer-events-none mix-blend-screen">
                      <div 
                        className={`h-full transition-[width] duration-75 ease-out shadow-[0_0_15px_rgba(255,255,255,0.2)] ${
                           currentDb > sensitivity ? 'bg-[#4ade80]' : 'bg-[#facc15]' 
                        }`}
                        style={{ width: `${dbToPercent(currentDb)}%` }}
                      />
                    </div>

                    {/* 3. Slider Input */}
                    <input
                      type="range"
                      min="-100"
                      max="0"
                      step="1"
                      value={sensitivity}
                      onChange={(e) => setSensitivity(parseInt(e.target.value))}
                      className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20"
                      title={`Gürültü Eşiği: ${sensitivity}dB`}
                    />

                    {/* 4. Slider Thumb */}
                    <div 
                      className="absolute top-1/2 -translate-y-1/2 w-[6px] h-7 bg-purple-100 rounded-[2px] shadow-[0_0_10px_rgba(168,85,247,0.5)] pointer-events-none z-10 transition-transform hover:scale-110 border border-purple-300"
                      style={{ 
                        left: `calc(${dbToPercent(sensitivity)}% - 3px)` 
                      }}
                    />

                     {/* 5. Markers */}
                     <div className="absolute bottom-1 inset-x-2 flex justify-between px-1 pointer-events-none">
                        <span className="text-[9px] text-gray-600">-100dB</span>
                        <span className="text-[9px] text-gray-600">0dB</span>
                     </div>

                </div>
                
                <p className="text-xs text-gray-500 mt-2 leading-relaxed">
                  Fan sesini kesmek için çubuğu sağa çek. 
                  <span className="text-yellow-500 font-bold mx-1">Sarı</span>: Ses kesiliyor. 
                  <span className="text-green-400 font-bold mx-1">Yeşil</span>: Ses iletiliyor.
                </p>
             </div>
          </div>
        )}

        {/* Info */}
        <div className="bg-[#121212] p-4 rounded-md border-l-4 border-purple-600 flex gap-3 shadow-md">
           <HelpCircle className="w-5 h-5 text-purple-500 shrink-0" />
           <div className="text-sm text-gray-400">
              Ses veya görüntüyle ilgili yardıma mı ihtiyacın var? <a href="#" className="text-purple-400 hover:text-purple-300 hover:underline">Sorun giderme rehberimize</a> göz at.
           </div>
        </div>

      </div>
    </div>
  );
}
